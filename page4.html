<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>World Street Food</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="css/colors.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/page4.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    /* ======= 食物卡片分享按钮 ======= */
    .share-icons {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-top: 6px;
      gap: 6px;
    }

    .share-icons a {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #a7c9a6;
      transition: 0.25s;
    }

    .share-icons i {
      font-size: 14px;
      color: #fff;
      pointer-events: none;
    }

    .share-icons a:nth-child(1):hover {
      background: #1877f2;
    }

    .share-icons a:nth-child(2):hover {
      background: #1da1f2;
    }

    .share-icons a:nth-child(3):hover {
      background: #25d366;
    }

    .share-icons a:hover {
      transform: scale(1.2);
    }

    /* ======= Modal 样式 ======= */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
      background: #fff;
      margin: 5% auto;
      padding: 20px;
      width: 80%;
      max-width: 900px;
      border-radius: 10px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }

    .nutrition-box {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .nutrition-box div {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 8px;
      flex: 1;
      text-align: center;
    }

    .recommend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .recommend-card img {
      width: 100%;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <!-- 顶部导航 -->
  <header>
    <nav class="glass-nav">
      <ul>
        <li><a href="page1.html" class="active">Home</a></li>
        <li><a href="page2.html">About us</a></li>
        <li><a href="page3.html">Malaysia</a></li>
        <li><a href="page4.html">World</a></li>
        <li><a href="page5.html">Cultural Stories</a></li>
        <li><a href="page6.html">Maps</a></li>
        <li><a href="page7.html">Review</a></li>
        <li><a href="page8.html">Contact us</a></li>
      </ul>
    </nav>
  </header>

  <!-- banner -->
  <div class="part2">
    <div class="banner">
      <div class="banner-slides">
        <img src="images/p4cover1.jpg" alt="Slide 1">
        <img src="images/p4cover2.jpg" alt="Slide 2">
      </div>
      <div class="hero-content">
        <h1>Welcome to World Street Food</h1>
        <p>Embark on a journey of taste and culture with flavors from every corner of the globe.</p>
      </div>
    </div>
  </div>

  <!-- 搜索 & 筛选 -->
  <div class="top-nav">
    <button id="menu-toggle" class="menu-btn">
      <i class="bi bi-funnel-fill"></i>
    </button>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search food...">
    </div>
  </div>

  <section class="section1">
    <div class="page-container">
      <div class="filter-panel">
        <h4>Country</h4>
        <select id="country-select"></select>

        <h4>Category</h4>
        <select id="category-select"></select>

        <h4>Ingredient</h4>
        <select id="ingredient-select"></select>
      </div>

      <div class="content-area">
        <div id="food-container" class="food-grid"></div>
      </div>
    </div>
  </section>

  <!-- ======= Modal 弹窗 ======= -->
  <div id="foodModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2 id="modal-title"></h2>
      <img id="modal-img" src="" alt="" style="width:100%; border-radius:10px;">
      <p id="modal-instructions"></p>

      <h3>Ingredients</h3>
      <ul id="modal-ingredients"></ul>

      <h3>Nutrition Info</h3>
      <div class="nutrition-box" id="modal-nutrition">
        <p>Loading nutrition data...</p>
      </div>

      <h3>Recommended</h3>
      <div class="recommend-grid" id="modal-recommend"></div>
    </div>
  </div>

  <!-- 脚本 -->
  <script>
    $(document).ready(function () {
      const $countrySelect = $("#country-select");
      const $categorySelect = $("#category-select");
      const $ingredientSelect = $("#ingredient-select");
      const $foodContainer = $("#food-container");
      const $searchInput = $("#search-input");

      let currentMeals = [];

      // ======= 初始化下拉选项 =======
      $.get("https://www.themealdb.com/api/json/v1/1/list.php?a=list", function (data) {
        if (data.meals) {
          $countrySelect.append(`<option value="">All</option>`);
          data.meals.forEach(item => {
            $countrySelect.append(`<option value="${item.strArea}">${item.strArea}</option>`);
          });
        }
      });

      $.get("https://www.themealdb.com/api/json/v1/1/list.php?c=list", function (data) {
        if (data.meals) {
          $categorySelect.append(`<option value="">All</option>`);
          data.meals.forEach(item => {
            $categorySelect.append(`<option value="${item.strCategory}">${item.strCategory}</option>`);
          });
        }
      });

      $.get("https://www.themealdb.com/api/json/v1/1/list.php?i=list", function (data) {
        if (data.meals) {
          $ingredientSelect.append(`<option value="">All</option>`);
          data.meals.slice(0, 50).forEach(item => {
            $ingredientSelect.append(`<option value="${item.strIngredient}">${item.strIngredient}</option>`);
          });
        }
      });

      // ======= 拉取并显示食物 =======
      function fetchFoods() {
        $foodContainer.html("<p>Loading...</p>");
        const country = $countrySelect.val();
        const category = $categorySelect.val();
        const ingredient = $ingredientSelect.val();
        const requests = [];

        if (country) requests.push($.get(`https://www.themealdb.com/api/json/v1/1/filter.php?a=${country}`));
        if (category) requests.push($.get(`https://www.themealdb.com/api/json/v1/1/filter.php?c=${category}`));
        if (ingredient) requests.push($.get(`https://www.themealdb.com/api/json/v1/1/filter.php?i=${ingredient}`));

        if (requests.length === 0) {
          $.get("https://www.themealdb.com/api/json/v1/1/filter.php?a=American", handleMeals);
        } else if (requests.length === 1) {
          requests[0].done(handleMeals);
        } else {
          $.when(...requests).done(function (...responses) {
            const mealsArrays = responses.map(r => r[0].meals || []);
            let intersection = mealsArrays[0];
            for (let i = 1; i < mealsArrays.length; i++) {
              const ids = mealsArrays[i].map(m => m.idMeal);
              intersection = intersection.filter(m => ids.includes(m.idMeal));
            }
            handleMeals({ meals: intersection });
          });
        }
      }

      function handleMeals(data) {
        if (data.meals) {
          currentMeals = data.meals;
          renderFood();
        } else {
          $foodContainer.html("<p>No meals found.</p>");
        }
      }

      function renderFood() {
        const searchVal = $searchInput.val().toLowerCase();
        $foodContainer.empty();
        currentMeals
          .filter(item => item.strMeal.toLowerCase().includes(searchVal))
          .forEach(item => {
            $.get(`https://www.themealdb.com/api/json/v1/1/lookup.php?i=${item.idMeal}`, function (detailData) {
              const detail = detailData.meals[0];
              const card = $(`
                <div class="food-card" style="cursor:pointer;">
                  <div class="food-img-wrapper">
                    <img src="${detail.strMealThumb}" alt="${detail.strMeal}">
                  </div>
                  <div class="food-content">
                    <h4>${detail.strMeal}</h4>
                    <p><strong>Category:</strong> ${detail.strCategory}</p>
                    <p><strong>Area:</strong> ${detail.strArea}</p>
                  </div>
                </div>
              `);

              // 点击打开详情
              card.click(() => showFoodDetail(detail));
              $foodContainer.append(card);
            });
          });
      }

      // ======= 显示 Modal 详情 =======
      function showFoodDetail(detail) {
        $("#modal-title").text(detail.strMeal);
        $("#modal-img").attr("src", detail.strMealThumb);
        $("#modal-instructions").text(detail.strInstructions);

        // 食材清单
        const $ingredients = $("#modal-ingredients");
        $ingredients.empty();
        for (let i = 1; i <= 20; i++) {
          const ing = detail[`strIngredient${i}`];
          const measure = detail[`strMeasure${i}`];
          if (ing && ing.trim() !== "") {
            $ingredients.append(`<li>${ing} - ${measure}</li>`);
          }
        }

        // 营养信息 (Edamam API)
        const query = encodeURIComponent(detail.strMeal);
        const app_id = "YOUR_APP_ID";
        const app_key = "YOUR_APP_KEY";
        $("#modal-nutrition").html("<p>Loading nutrition data...</p>");

        $.get(`https://api.edamam.com/api/nutrition-data?app_id=${app_id}&app_key=${app_key}&ingr=${query}`, function (nutri) {
          if (nutri.calories) {
            $("#modal-nutrition").html(`
              <div>Calories<br><strong>${nutri.calories}</strong></div>
              <div>Protein<br><strong>${nutri.totalNutrients.PROCNT?.quantity.toFixed(1)} g</strong></div>
              <div>Fat<br><strong>${nutri.totalNutrients.FAT?.quantity.toFixed(1)} g</strong></div>
              <div>Carbs<br><strong>${nutri.totalNutrients.CHOCDF?.quantity.toFixed(1)} g</strong></div>
            `);
          } else {
            $("#modal-nutrition").html("<p>No nutrition data available.</p>");
          }
        });

        // 推荐食物
        $("#modal-recommend").html("<p>Loading recommendations...</p>");
        $.get(`https://www.themealdb.com/api/json/v1/1/filter.php?c=${detail.strCategory}`, function (recData) {
          if (recData.meals) {
            const recs = recData.meals.filter(m => m.idMeal !== detail.idMeal).slice(0, 4);
            $("#modal-recommend").empty();
            recs.forEach(rec => {
              $("#modal-recommend").append(`
                <div class="recommend-card">
                  <img src="${rec.strMealThumb}" alt="${rec.strMeal}">
                  <p>${rec.strMeal}</p>
                </div>
              `);
            });
          }
        });

        $("#foodModal").fadeIn();
      }

      $(".modal-close").click(() => $("#foodModal").fadeOut());

      $countrySelect.change(fetchFoods);
      $categorySelect.change(fetchFoods);
      $ingredientSelect.change(fetchFoods);
      $searchInput.on("input", renderFood);

      fetchFoods();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>
